<!doctype html>
<meta charset="utf-8">
<title>Compile Protocol Picker (Ratio only)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,Arial,sans-serif;background:#0d1117;color:#e6edf3;margin:24px}
  h1{font-size:20px;margin:0 0 10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#111827;border:1px solid #263244;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  textarea{width:100%;min-height:120px;background:#0b1220;color:#e6edf3;border:1px solid #263244;border-radius:10px;padding:8px}
  input[type="number"]{background:#0b1220;color:#e6edf3;border:1px solid #263244;border-radius:8px;padding:6px 8px;width:88px}
  button{background:#1f2937;border:1px solid #2d3a4a;color:#e6edf3;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  button:hover{background:#263244}
  .result{white-space:pre-wrap;background:#0b1220;border:1px dashed #2d3a4a;border-radius:10px;padding:10px;min-height:90px;margin-top:8px}
  .small{color:#9aa6b2;font-size:12px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #2d3a4a;border-radius:999px;margin:4px 6px 0 0}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
</style>

<h1>Compile Protocol Pickerï¼ˆãƒ¬ã‚·ã‚ªåˆ¶ï¼‰</h1>

<div class="grid">
  <!-- ãƒ—ãƒ¼ãƒ« -->
  <div class="card">
    <div class="row">
      <label class="small"><input type="checkbox" id="auxToggle"> Aux 1ï¼ˆHATE / LOVE / APATHYï¼‰ã‚’é™¤å¤–</label>
      <span class="small">è¡Œã”ã¨ã«1ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‚ç·¨é›†å¯ã€‚</span>
    </div>
    <textarea id="pool">DEATH
FIRE
GRAVITY
LIFE
LIGHT
METAL
PLAGUE
PSYCHIC
SPEED
SPIRIT
DARKNESS
WATER</textarea>
    <div class="row">
      <button id="reset">åˆæœŸåŒ–</button>
      <button id="shuffle">è¡¨ç¤ºã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
      <button id="clear">çµæœã‚¯ãƒªã‚¢</button>
    </div>
    <div id="chips"></div>
  </div>

  <!-- æŠ½é¸ï¼†ãƒ¬ã‚·ã‚ª -->
  <div class="card">
    <div class="row">
      <button id="pick1">1æšãƒ©ãƒ³ãƒ€ãƒ </button>
      <button id="pick3">3æšï¼ˆé‡è¤‡ãªã—ï¼‰</button>
      <button id="pickRatioBuild">ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‡ãƒƒã‚­æ§‹ç¯‰</button>
      <button id="draftRandom">å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆP1 vs P2ï¼‰</button>
      <button id="draftRatio">ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆP1 vs P2ï¼‰</button>
    </div>
    <div class="row">
      <label class="small">æšæ•° <input type="number" id="cnt" value="3" min="2" max="6"></label>
      <label class="small">åˆè¨ˆMin <input type="number" id="minSum" value="7"></label>
      <label class="small">åˆè¨ˆMax <input type="number" id="maxSum" value="8"></label>
    </div>
    <div id="out" class="result"></div>
    <div class="row">
      <div style="flex:1">
        <div class="small">ãƒ¬ã‚·ã‚ªï¼ˆåˆæœŸå€¤ã¯ã‚ãªãŸã®è¨­å®š / 0è¨±å¯ï¼‰</div>
        <textarea id="ratioTA">FIRE=5
DARKNESS=5
PSYCHIC=5
HATE=5
WATER=3
DEATH=3
GRAVITY=3
LOVE=2
PLAGUE=2
LIFE=2
LIGHT=1
SPEED=1
SPIRIT=1
APATHY=0
METAL=0</textarea>
        <button id="saveRatio">ãƒ¬ã‚·ã‚ªã‚’ä¿å­˜</button>
      </div>
    </div>
    <div id="ratioView" class="small" style="margin-top:8px;"></div>
  </div>
</div>

<script>
const dMain = ["DEATH","FIRE","GRAVITY","LIFE","LIGHT","METAL","PLAGUE","PSYCHIC","SPEED","SPIRIT","DARKNESS","WATER"];
const auxSet = ["HATE","LOVE","APATHY"];
const LS = { pool:"compile.pool", ratio:"compile.ratio", params:"compile.params", aux:"compile.auxExcluded" };

const poolTA = document.getElementById('pool');
const chips = document.getElementById('chips');
const auxToggle = document.getElementById('auxToggle');
const out = document.getElementById('out');
const ratioTA = document.getElementById('ratioTA');
const ratioView = document.getElementById('ratioView');
const cntIn = document.getElementById('cnt');
const minIn = document.getElementById('minSum');
const maxIn = document.getElementById('maxSum');

function uniq(lines){
  const seen=new Set(), arr=[];
  for(const s of lines){ const t=(s||"").trim().toUpperCase(); if(t && !seen.has(t)){ seen.add(t); arr.push(t); } }
  return arr;
}
function getPool(){ return uniq(poolTA.value.split(/\r?\n/)); }
function setPool(list){ poolTA.value = list.join("\n"); renderChips(); }
function renderChips(){ const pool=getPool(); chips.innerHTML = pool.map(p=>`<span class="pill">${p}</span>`).join(""); }
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function sample(a,n){ return shuffle(a).slice(0, Math.min(n,a.length)); }

function parseRatio(text){
  const map = Object.create(null);
  for(const line of (text||"").split(/\r?\n/)){
    const t=(line||"").trim(); if(!t) continue;
    const idx=t.indexOf("="); if(idx<0) continue;
    const k=t.slice(0,idx).trim().toUpperCase();
    const v=Number(t.slice(idx+1).trim());
    if(k && !isNaN(v) && v>=0) map[k]=v; // 0ã‚’è¨±å¯
  }
  return map;
}
function ratioOf(k){ const R=parseRatio(localStorage.getItem(LS.ratio) || ratioTA.value); return R[k] ?? 1; }
function showRatioPreview(){
  const pool = getPool(); const R = parseRatio(localStorage.getItem(LS.ratio) || ratioTA.value);
  const rows = pool.map(k => `${k}: ${R[k] ?? 1}`);
  ratioView.textContent = "ç¾åœ¨ã®ãƒ¬ã‚·ã‚ª â†’ " + rows.join(" / ");
}

function saveAll(){
  localStorage.setItem(LS.pool, poolTA.value);
  localStorage.setItem(LS.ratio, ratioTA.value);
  localStorage.setItem(LS.params, JSON.stringify({cnt:+cntIn.value, min:+minIn.value, max:+maxIn.value}));
  localStorage.setItem(LS.aux, auxToggle.checked ? "1" : "0");
}
function loadAll(){
  // AuxåˆæœŸï¼šå«ã‚ã‚‹ï¼ˆ= é™¤å¤–OFFï¼‰
  auxToggle.checked = (localStorage.getItem(LS.aux) ?? "0") === "1";

  const poolSaved = localStorage.getItem(LS.pool);
  if(poolSaved){ poolTA.value = poolSaved; }
  else{
    // åˆæœŸã¯ Main + Aux1 ã‚’å«ã‚ã‚‹
    setPool(dMain.concat(auxSet));
  }
  const rSaved = localStorage.getItem(LS.ratio); if(rSaved) ratioTA.value = rSaved;
  const params = localStorage.getItem(LS.params);
  if(params){ try{ const p=JSON.parse(params)||{}; cntIn.value=p.cnt??3; minIn.value=p.min??7; maxIn.value=p.max??8; }catch(e){} }

  // Aux é™¤å¤–ONãªã‚‰å‰Šé™¤ã€OFFãªã‚‰è¿½åŠ 
  if(auxToggle.checked){
    setPool(getPool().filter(x=>!auxSet.includes(x)));
  }else{
    const cur=getPool(); const add=auxSet.filter(x=>!cur.includes(x));
    if(add.length) setPool(cur.concat(add));
  }
  renderChips(); showRatioPreview();
}

document.getElementById('reset').onclick = ()=>{
  let list = dMain.slice();
  if(!auxToggle.checked) list = list.concat(auxSet);
  setPool(list); out.textContent=""; saveAll(); showRatioPreview();
};
document.getElementById('shuffle').onclick = ()=>{ setPool(shuffle(getPool())); saveAll(); };
document.getElementById('clear').onclick = ()=> out.textContent="";
document.getElementById('pick1').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 1æšãƒ©ãƒ³ãƒ€ãƒ \n"+sample(p,1)[0]):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; };
document.getElementById('pick3').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 3æšï¼ˆé‡è¤‡ãªã—ï¼‰\n- "+sample(p,3).join("\n- ")):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; };

// ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‡ãƒƒã‚­æ§‹ç¯‰ï¼ˆNæšã€åˆè¨ˆminã€œmaxã€è¡¨ç¤ºã¯ NAME(V)ï¼‰
document.getElementById('pickRatioBuild').onclick = ()=>{
  const pool = getPool(), N=+cntIn.value, minS=+minIn.value, maxS=+maxIn.value;
  if(pool.length<N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+N+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; return; }
  const cost = k => ratioOf(k);
  const combos=[];
  function rec(start, acc, sum){
    if(acc.length===N){ if(sum>=minS && sum<=maxS) combos.push({arr:acc.slice(), s:sum}); return; }
    for(let i=start;i<pool.length;i++){
      const k=pool[i]; acc.push(k); rec(i+1, acc, sum+cost(k)); acc.pop();
    }
  }
  rec(0, [], 0);
  if(!combos.length){ out.textContent="æ¡ä»¶ï¼ˆåˆè¨ˆ"+minS+"ã€œ"+maxS+" / "+N+"æšï¼‰ã«åˆã†çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¬ã‚·ã‚ªã‚„ãƒ—ãƒ¼ãƒ«ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚"; return; }
  const pick = combos[Math.floor(Math.random()*combos.length)];
  const listed = pick.arr.map(k => `${k}(${cost(k)})`).join("\n- ");
  out.textContent = `ğŸ§® ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‡ãƒƒã‚­æ§‹ç¯‰ï¼ˆ${minS}ã€œ${maxS} / ${N}æšï¼‰\n- ${listed}\nåˆè¨ˆ: ${pick.s}`;
};

// ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆP1 vs P2ï¼‰ï¼šå„Næšãƒ»ä¸¡è€…ã¨ã‚‚åˆè¨ˆminã€œmax
document.getElementById('draftRatio').onclick = ()=>{
  const pool = getPool(), N=+cntIn.value, minS=+minIn.value, maxS=+maxIn.value;
  if(pool.length < 2*N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+(2*N)+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; return; }
  const cost = k => ratioOf(k);

  // ã¾ãšNæšã§æ¡ä»¶ã‚’æº€ãŸã™å…¨çµ„åˆã›ã‚’åˆ—æŒ™
  const combos=[];
  function rec(start, acc, sum){
    if(acc.length===N){ if(sum>=minS && sum<=maxS) combos.push({set:new Set(acc), arr:acc.slice(), s:sum}); return; }
    for(let i=start;i<pool.length;i++){
      const k=pool[i]; acc.push(k); rec(i+1, acc, sum+cost(k)); acc.pop();
    }
  }
  rec(0, [], 0);
  if(!combos.length){ out.textContent="æ¡ä»¶ã‚’æº€ãŸã™"+N+"æšã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"; return; }

  // 2äººåˆ†ï¼šäº’ã„ã«é‡ãªã‚‰ãªã„2ã‚»ãƒƒãƒˆã‚’æ¢ã™ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é †ã§è©¦ã™ï¼‰
  const order = shuffle(combos);
  let best = null;
  outer: for(const c1 of order){
    for(const c2 of order){
      if(c1===c2) continue;
      let disjoint = true;
      for(const k of c1.set){ if(c2.set.has(k)){ disjoint=false; break; } }
      if(disjoint){ best = [c1, c2]; break outer; }
    }
  }
  if(!best){ out.textContent="äº’ã„ã«é‡è¤‡ã—ãªã„2ã‚»ãƒƒãƒˆãŒä½œã‚Œã¾ã›ã‚“ã€‚ãƒ—ãƒ¼ãƒ«ã‚„æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚"; return; }

  // å…ˆè¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
  const first = Math.random()<0.5 ? "P1" : "P2";
  const P1 = best[0].arr.slice(), P2 = best[1].arr.slice();

  // è¡¨ç¤ºï¼ˆåå‰(ãƒ¬ã‚·ã‚ª)ï¼‰
  const fmt = a => a.map((k,i)=>`${i+1}. ${k}(${cost(k)})`).join("\n");
  out.textContent =
`ğŸŒ€ ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆå„${N}æš / åˆè¨ˆ${minS}ã€œ${maxS}ï¼‰
å…ˆè¡Œ: ${first}
ãƒ‰ãƒ©ãƒ•ãƒˆé †: P1â†’P2Ã—2â†’P1Ã—2â†’P2

P1 åˆè¨ˆ=${best[0].s}
${fmt(P1)}

P2 åˆè¨ˆ=${best[1].s}
${fmt(P2)}

æ®‹ã‚Šãƒ—ãƒ¼ãƒ« (${pool.length - P1.length - P2.length})
- ${pool.filter(x=>!P1.includes(x)&&!P2.includes(x)).join(", ")}`;
};

document.getElementById('saveRatio').onclick = ()=>{ localStorage.setItem(LS.ratio, ratioTA.value); saveAll(); showRatioPreview(); };

auxToggle.addEventListener('change', ()=>{
  let l=getPool();
  if(auxToggle.checked){ setPool(l.filter(x=>!auxSet.includes(x))); }
  else{ for(const x of auxSet) if(!l.includes(x)) l.push(x); setPool(l); }
  saveAll(); showRatioPreview();
});
poolTA.addEventListener('input', ()=>{ renderChips(); saveAll(); showRatioPreview(); });
[cntIn, minIn, maxIn].forEach(el=>el.addEventListener('input', saveAll));

// åˆæœŸåŒ–ï¼šãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãŒç„¡ã‘ã‚Œã°ã€ãƒ¬ã‚·ã‚ªåˆæœŸå€¤ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ»ãƒ—ãƒ¼ãƒ«(Main+Aux)ã‚’æŠ•å…¥
if(!localStorage.getItem(LS.ratio)) localStorage.setItem(LS.ratio, document.getElementById('ratioTA').value);
if(!localStorage.getItem(LS.params)) localStorage.setItem(LS.params, JSON.stringify({cnt:3,min:7,max:8}));
if(localStorage.getItem(LS.aux)===null) localStorage.setItem(LS.aux,"0");
if(!localStorage.getItem(LS.pool)){
  localStorage.setItem(LS.pool, dMain.concat(auxSet).join("\n"));
}

loadAll();
  <script>
// â€¦æ—¢å­˜ã®é–¢æ•°ãƒ»å¤‰æ•°ã¯ãã®ã¾ã¾â€¦

// æ±ç”¨ã‚¹ãƒãƒ¼ã‚¯é †ã‚’ä½œã‚‹ï¼ˆP1:1 â†’ P2:2 â†’ P1:2 â†’ P2:1 ã‚’ç¹°ã‚Šè¿”ã—ã€æ®‹ã‚Šæšæ•°ã«åˆã‚ã›ã¦åˆ‡ã‚Šè©°ã‚ï¼‰
function makeSnakeSequence(nEach){
  const seqPattern = [['P1',1],['P2',2],['P1',2],['P2',1]];
  const rem = {P1:nEach, P2:nEach};
  const seq = [];
  let i = 0;
  while (rem.P1 > 0 || rem.P2 > 0) {
    const [who, take] = seqPattern[i % seqPattern.length];
    const actual = Math.min(take, rem[who]);
    if (actual > 0) { seq.push([who, actual]); rem[who] -= actual; }
    i++; if (i > 200) break; // ã‚»ãƒ¼ãƒ•ãƒ†ã‚£
  }
  return seq;
}

// â˜… å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆã‚³ã‚¹ãƒˆç„¡è¦–ãƒ»ã‚¹ãƒãƒ¼ã‚¯é †ã«å¾“ã£ã¦é…åˆ†ï¼‰
document.getElementById('draftRandom').onclick = ()=>{
  const pool = getPool().slice();
  const N = +cntIn.value;         // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æšæ•°ï¼ˆUIã¨é€£å‹•ï¼‰
  if (pool.length < 2 * N) { out.textContent = `ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ${2*N}ä»¥ä¸Šå¿…è¦ï¼‰ã€‚`; return; }

  // å…ˆè¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®šï¼ˆè¡¨ç¤ºç”¨ï¼‰ã€‚é…åˆ†ã¯ã‚¹ãƒãƒ¼ã‚¯é †ã‚’ã€Œå…ˆè¡Œå´=ãƒ™ãƒ¼ã‚¹P1ã€ã¨ã—ã¦è¡Œã†ã€‚
  const first = Math.random() < 0.5 ? 'P1' : 'P2';

  // ãƒ‰ãƒ©ãƒ•ãƒˆé †ã«ä½¿ã†ãƒ—ãƒ¼ãƒ«ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const bag = shuffle(pool);

  // å…ˆè¡ŒãŒP2ã®å ´åˆã¯ã€å½¹å‰²ã‚’å…¥ã‚Œæ›¿ãˆã¦ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é©ç”¨
  const seq = makeSnakeSequence(N).map(([who, take])=>{
    if (first === 'P1') return [who, take];
    // å…ˆè¡ŒãŒP2ãªã‚‰P1<->P2ã‚’ã‚¹ãƒ¯ãƒƒãƒ—
    return [who === 'P1' ? 'P2' : 'P1', take];
  });

  const picks = {P1:[], P2:[]};
  for (const [who, take] of seq) {
    picks[who].push(...bag.splice(0, take));
  }

  // è¡¨ç¤º
  const fmt = a => a.map((k,i)=>`${i+1}. ${k}`).join("\n");
  const leftover = bag.join(", ");
  out.textContent =
`ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆå„${N}æšï¼ã‚³ã‚¹ãƒˆç„¡è¦–ï¼‰
å…ˆè¡Œ: ${first}
ãƒ‰ãƒ©ãƒ•ãƒˆé †: P1â†’P2Ã—2â†’P1Ã—2â†’P2

P1
${fmt(picks.P1)}

P2
${fmt(picks.P2)}

æ®‹ã‚Šãƒ—ãƒ¼ãƒ« (${bag.length})
- ${leftover}`;
};
</script>

</script>
