      <button id="pick3">ãƒ©ãƒ³ãƒ€ãƒ 3æš</button>
    </div>

<div class="row">
  <button id="draftRatio">ãƒ¬ã‚·ã‚ªP1vsP2</button>
  <button id="pickRatioBuild">ãƒ¬ã‚·ã‚ª3æš</button>
</div>
<div class="row">
  <label class="small">æšæ•°
    <input type="number" id="cnt" value="3" min="2" max="6" inputmode="numeric">
  </label>
</div>


      <!-- P1/P2 ãã‚Œãã‚Œã® Min/Max -->
      <span class="small" style="margin-left:8px">P1:</span>
      <label class="small">Min <input type="number" id="p1Min" value="7" inputmode="numeric"></label>
      <label class="small">Max <input type="number" id="p1Max" value="8" inputmode="numeric"></label>

      <span class="small" style="margin-left:8px">P2:</span>
      <label class="small">Min <input type="number" id="p2Min" value="7" inputmode="numeric"></label>
      <label class="small">Max <input type="number" id="p2Max" value="8" inputmode="numeric"></label>

      <!-- æ§‹ç¯‰ã§ä½¿ã†è¨­å®šã®é¸æŠ -->
      <label class="small" style="margin-left:auto;">ãƒ¬ã‚·ã‚ª3æšã®åˆ¤å®š
        <select id="buildSide">
          <option value="P1">P1ã®è¨­å®š</option>
          <option value="P2">P2ã®è¨­å®š</option>
        </select>
      </label>
            <label class="small" style="display:flex;align-items:center;gap:6px;margin-left:auto;">
        <input type="checkbox" id="auxToggle"> Aux1ï¼ˆHATE/LOVE/APATHYï¼‰ã‚’é™¤å¤–
    <div class="row">
      <button id="draftRatio">ãƒ¬ã‚·ã‚ªP1vsP2</button>
      <button id="pickRatioBuild">ãƒ¬ã‚·ã‚ª3æš</button>
    </div>
    <div class="row">
      <label class="small">æšæ•°
        <input type="number" id="cnt" value="3" min="2" max="6" inputmode="numeric">
      </label>
    </div>

    <!-- P1/P2 ãã‚Œãã‚Œã® Min/Max -->
    <span class="small" style="margin-left:8px">P1:</span>
    <label class="small">Min <input type="number" id="p1Min" value="7" inputmode="numeric"></label>
    <label class="small">Max <input type="number" id="p1Max" value="8" inputmode="numeric"></label>

    <span class="small" style="margin-left:8px">P2:</span>
    <label class="small">Min <input type="number" id="p2Min" value="7" inputmode="numeric"></label>
    <label class="small">Max <input type="number" id="p2Max" value="8" inputmode="numeric"></label>

    <!-- æ§‹ç¯‰ã§ä½¿ã†è¨­å®šã®é¸æŠ -->
    <label class="small" style="margin-left:auto;">ãƒ¬ã‚·ã‚ª3æšã®åˆ¤å®š
      <select id="buildSide">
        <option value="P1">P1ã®è¨­å®š</option>
        <option value="P2">P2ã®è¨­å®š</option>
      </select>
    </label>
    <label class="small" style="display:flex;align-items:center;gap:6px;margin-left:auto;">
      <input type="checkbox" id="auxToggle"> Aux1ï¼ˆHATE/LOVE/APATHYï¼‰ã‚’é™¤å¤–
    </label>

    <div id="out" class="result" aria-live="polite"></div>
    <!-- å…±æœ‰ãƒœã‚¿ãƒ³è¡Œï¼ˆå‹•çš„è¡¨ç¤ºï¼‰ -->
    <div id="shareRow" class="row" style="justify-content:flex-end; display:none;">
      <button id="shareBtn">å…±æœ‰</button>
      <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <!-- ä¸‹éƒ¨å›ºå®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¦ªæŒ‡ç”¨ï¼‰ -->
    <div class="sticky-actions">
@@ -142,6 +145,7 @@ <h1>Compile Picker</h1>
const dMain = ["DEATH","FIRE","GRAVITY","LIFE","LIGHT","METAL","PLAGUE","PSYCHIC","SPEED","SPIRIT","DARKNESS","WATER"];
const auxSet = ["HATE","LOVE","APATHY"];
const LS = { pool:"compile.pool", ratio:"compile.ratio", params:"compile.params", aux:"compile.auxExcluded" };
const CP_LINK = "https://princetottino10-bit.github.io/compile-picker/compile_protocol_picker.html";

/* ---------- è¦ç´ å–å¾— ---------- */
const poolTA = document.getElementById('pool');
@@ -219,12 +223,41 @@ <h1>Compile Picker</h1>
}
function revealResult(){ out.scrollIntoView({behavior:'smooth', block:'nearest'}); }

/* ---------- å…±æœ‰ï¼šUI & å‹•ä½œ ---------- */
const shareRow = document.getElementById('shareRow');
const shareBtn = document.getElementById('shareBtn');
const copyBtn = document.getElementById('copyBtn');
function getShareText(){
  let txt = (out.textContent || "").trim();
  if(!txt.includes(CP_LINK)) txt += `\n\nğŸ”— Compile Picker: ${CP_LINK}`;
  return txt;
}
function updateShareButtons(){
  const has = !!(out.textContent && out.textContent.trim());
  shareRow.style.display = has ? "flex" : "none";
}
shareBtn.onclick = async ()=>{
  const text = getShareText();
  try{
    if(navigator.share){ await navigator.share({ text }); }
    else{ await navigator.clipboard.writeText(text); alert("å…±æœ‰APIãŒä½¿ãˆãªã„ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"); }
  }catch(e){ console.warn(e); }
};
copyBtn.onclick = async ()=>{
  const text = getShareText();
  try{
    await navigator.clipboard.writeText(text);
    const old = copyBtn.textContent; copyBtn.textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†";
    setTimeout(()=> copyBtn.textContent = old, 1200);
  }catch(e){ alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
};

/* ---------- åŸºæœ¬æ“ä½œ ---------- */
document.getElementById('reset').onclick = ()=>{ let list=dMain.slice(); if(!auxToggle.checked) list=list.concat(auxSet); setPool(list); out.textContent=""; saveAll(); showRatioPreview(); };
document.getElementById('reset').onclick = ()=>{ let list=dMain.slice(); if(!auxToggle.checked) list=list.concat(auxSet); setPool(list); out.textContent=""; saveAll(); showRatioPreview(); updateShareButtons(); };
document.getElementById('shuffle').onclick = ()=>{ setPool(shuffle(getPool())); saveAll(); };
document.getElementById('clear').onclick = ()=> out.textContent="";
document.getElementById('pick1').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 1æšãƒ©ãƒ³ãƒ€ãƒ \n"+sample(p,1)[0]):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; revealResult(); };
document.getElementById('pick3').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 3æšãƒ©ãƒ³ãƒ€ãƒ ï¼ˆé‡è¤‡ãªã—ï¼‰\n- "+sample(p,3).join("\n- ")):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; revealResult(); };
document.getElementById('clear').onclick = ()=>{ out.textContent=""; updateShareButtons(); };
document.getElementById('pick1').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 1æšãƒ©ãƒ³ãƒ€ãƒ \n"+sample(p,1)[0]):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; revealResult(); updateShareButtons(); };
document.getElementById('pick3').onclick = ()=>{ const p=getPool(); const n=+cntIn.value||3; out.textContent = p.length?("ğŸ² "+n+"æšãƒ©ãƒ³ãƒ€ãƒ ï¼ˆé‡è¤‡ãªã—ï¼‰\n- "+sample(p,n).join("\n- ")):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; revealResult(); updateShareButtons(); };
document.getElementById('saveRatio').onclick = ()=>{ localStorage.setItem(LS.ratio, ratioTA.value); showRatioPreview(); };
auxToggle.addEventListener('change', ()=>{ let l=getPool(); if(auxToggle.checked){ setPool(l.filter(x=>!auxSet.includes(x))); } else { for(const x of auxSet) if(!l.includes(x)) l.push(x); setPool(l); } saveAll(); showRatioPreview(); });
[poolTA, ratioTA, cntIn, p1MinIn, p1MaxIn, p2MinIn, p2MaxIn, buildSideSel].forEach(el=>el.addEventListener('input', saveAll));
@@ -234,62 +267,89 @@ <h1>Compile Picker</h1>
document.getElementById('runDraftRatio').onclick  = ()=> document.getElementById('draftRatio').click();
document.getElementById('runBuild').onclick       = ()=> document.getElementById('pickRatioBuild').click();

/* ---------- ãƒ¬ã‚·ã‚ªåˆ¶ï¼šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */
/* ---------- ãƒ¬ã‚·ã‚ªåˆ¶ï¼šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆé«˜é€Ÿç‰ˆï¼‰ ---------- */
function enumerateCombos(pool, N, minSum, maxSum, costFn){
  const items = pool.map(k=>({k, c: costFn(k)})).sort((a,b)=>a.c-b.c);
  const keys  = items.map(x=>x.k);
  const costs = items.map(x=>x.c);

  const prefix = new Array(costs.length+1).fill(0);
  for(let i=0;i<costs.length;i++) prefix[i+1] = prefix[i] + costs[i];

  const res=[];
  function rec(start, acc, sum){
    if(acc.length===N){ if(sum>=minSum && sum<=maxSum) res.push({set:new Set(acc), arr:acc.slice(), s:sum}); return; }
    for(let i=start;i<pool.length;i++){
      const k=pool[i]; acc.push(k); rec(i+1, acc, sum+costFn(k)); acc.pop();
  const pick = new Array(N);

  function rec(start, depth, sum){
    const remain = N - depth;
    if(remain>0){
      const minTail = prefix[start+remain] - prefix[start];
      if(sum + minTail > maxSum) return; // ä¸Šé™è¶…ãˆç¢ºå®šâ†’æåˆˆã‚Š
    }
    if(depth===N){
      if(sum>=minSum && sum<=maxSum) res.push({ set:new Set(pick), arr: pick.slice(), s: sum });
      return;
    }
    for(let i=start; i<=keys.length - remain; i++){
      const c = costs[i];
      if(sum + c > maxSum) break; // æ˜‡é †ãªã®ã§ã“ã‚Œä»¥é™ã‚‚ã‚ªãƒ¼ãƒãƒ¼
      pick[depth] = keys[i];
      rec(i+1, depth+1, sum + c);
    }
  }
  rec(0, [], 0);
  rec(0, 0, 0);
  return res;
}

/* ---------- ãƒ¬ã‚·ã‚ªåˆ¶ï¼š1äººåˆ†æ§‹ç¯‰ï¼ˆP1è¨­å®š or P2è¨­å®šã§åˆ¤å®šï¼‰ ---------- */
document.getElementById('pickRatioBuild').onclick = ()=>{
  const pool = getPool(), N=+cntIn.value;
  if(pool.length<N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+N+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; revealResult(); return; }
  const cost = k => costOf(k);
  if(pool.length<N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+N+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; revealResult(); updateShareButtons(); return; }

  const ratioMap = getRatioMap();
  const cost = k => (ratioMap[k] ?? 1);

  const side = buildSideSel.value; // "P1" or "P2"
  const minS = side==="P1" ? +p1MinIn.value : +p2MinIn.value;
  const maxS = side==="P1" ? +p1MaxIn.value : +p2MaxIn.value;

  const combos = enumerateCombos(pool, N, minS, maxS, cost);
  if(!combos.length){ out.textContent=`æ¡ä»¶ï¼ˆ${side}è¨­å®š: åˆè¨ˆ${minS}ã€œ${maxS} / ${N}æšï¼‰ã«åˆã†çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¬ã‚·ã‚ªã‚„ãƒ—ãƒ¼ãƒ«ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚`; revealResult(); return; }
  if(!combos.length){
    const costs = pool.map(cost).sort((a,b)=>a-b);
    const minPossible = costs.slice(0, N).reduce((a,b)=>a+b,0);
    const maxPossible = costs.slice(-N).reduce((a,b)=>a+b,0);
    out.textContent=`æ¡ä»¶ï¼ˆ${side}è¨­å®š: åˆè¨ˆ${minS}ã€œ${maxS} / ${N}æšï¼‰ã«åˆã†çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nãƒ’ãƒ³ãƒˆï¼šã“ã®ãƒ—ãƒ¼ãƒ«ã ã¨ç†è«–ä¸Šã®æœ€å°=${minPossible}, æœ€å¤§=${maxPossible} ã§ã™ã€‚Min/Maxã‚„ãƒ¬ã‚·ã‚ªã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚`;
    revealResult(); updateShareButtons(); return;
  }

  const pick = combos[Math.floor(Math.random()*combos.length)];
  const listed = pick.arr.map(k => `${k}(${cost(k)})`).join("\n- ");
  out.textContent = `ğŸ§® ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‡ãƒƒã‚­æ§‹ç¯‰ï¼ˆ${side}è¨­å®š / ${minS}ã€œ${maxS} / ${N}æšï¼‰\n- ${listed}\nåˆè¨ˆ: ${pick.s}`;
  revealResult();
  out.textContent = `ğŸ§® ãƒ¬ã‚·ã‚ªåˆ¶ãƒ‡ãƒƒã‚­æ§‹ç¯‰ï¼ˆ${side}è¨­å®š / ${minS}ã€œ${maxS} / ${N}æšï¼‰\n- ${listed}\nåˆè¨ˆ: ${pick.s}\n\nğŸ”— Compile Picker: ${CP_LINK}`;
  revealResult(); updateShareButtons();
};

/* ---------- ãƒ¬ã‚·ã‚ªåˆ¶ï¼šãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆP1/P2 ãã‚Œãã‚Œã®Min/Maxã‚’æº€ãŸã™ï¼‰ ---------- */
/* ---------- ãƒ¬ã‚·ã‚ªåˆ¶ï¼šãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆP1â†’æ®‹ã‚Šã‹ã‚‰P2æ¢ç´¢ï¼‰ ---------- */
document.getElementById('draftRatio').onclick = ()=>{
  const pool = getPool(), N=+cntIn.value;
  if(pool.length < 2*N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+(2*N)+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; revealResult(); return; }
  const cost = k => costOf(k);
  if(pool.length < 2*N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+(2*N)+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; revealResult(); updateShareButtons(); return; }

  const ratioMap = getRatioMap();
  const cost = k => (ratioMap[k] ?? 1);

  const p1Min=+p1MinIn.value, p1Max=+p1MaxIn.value;
  const p2Min=+p2MinIn.value, p2Max=+p2MaxIn.value;

  const p1Combos = enumerateCombos(pool, N, p1Min, p1Max, cost);
  const p2Combos = enumerateCombos(pool, N, p2Min, p2Max, cost);
  if(!p1Combos.length){ out.textContent=`P1æ¡ä»¶ï¼ˆåˆè¨ˆ${p1Min}ã€œ${p1Max} / ${N}æšï¼‰ã‚’æº€ãŸã™ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`; revealResult(); return; }
  if(!p2Combos.length){ out.textContent=`P2æ¡ä»¶ï¼ˆåˆè¨ˆ${p2Min}ã€œ${p2Max} / ${N}æšï¼‰ã‚’æº€ãŸã™ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`; revealResult(); return; }
  if(!p1Combos.length){ out.textContent=`P1æ¡ä»¶ï¼ˆåˆè¨ˆ${p1Min}ã€œ${p1Max} / ${N}æšï¼‰ã‚’æº€ãŸã™ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`; revealResult(); updateShareButtons(); return; }

  // é‡è¤‡ã—ãªã„2ã‚»ãƒƒãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ æ¢ç´¢ï¼ˆP1å€™è£œÃ—P2å€™è£œï¼‰
  const p1Order = shuffle(p1Combos), p2Order = shuffle(p2Combos);
  const p1Order = shuffle(p1Combos);
  let best=null;
  outer: for(const c1 of p1Order){
    for(const c2 of p2Order){
      let ok=true;
      for(const k of c1.set){ if(c2.set.has(k)){ ok=false; break; } }
      if(ok){ best=[c1,c2]; break outer; }
    }
  for(const c1 of p1Order){
    const remainPool = pool.filter(x=>!c1.set.has(x));
    if(remainPool.length < N) continue;
    const p2Combos = enumerateCombos(remainPool, N, p2Min, p2Max, cost);
    if(p2Combos.length){ best=[c1, p2Combos[Math.floor(Math.random()*p2Combos.length)]]; break; }
  }
  if(!best){ out.textContent="äº’ã„ã«é‡è¤‡ã—ãªã„2ã‚»ãƒƒãƒˆãŒä½œã‚Œã¾ã›ã‚“ã€‚ãƒ—ãƒ¼ãƒ«ã‚„å„æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚"; revealResult(); return; }
  if(!best){ out.textContent="äº’ã„ã«é‡è¤‡ã—ãªã„2ã‚»ãƒƒãƒˆãŒä½œã‚Œã¾ã›ã‚“ã€‚ãƒ—ãƒ¼ãƒ«ã‚„å„æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚"; revealResult(); updateShareButtons(); return; }

  const first = Math.random()<0.5 ? "P1" : "P2"; // å…ˆæ”»
  const P1 = best[0].arr.slice(), P2 = best[1].arr.slice();
@@ -307,13 +367,15 @@ <h1>Compile Picker</h1>
${fmt(P2)}

æ®‹ã‚Šãƒ—ãƒ¼ãƒ« (${remain.length})
- ${remain.join(", ")}`;
  revealResult();
- ${remain.join(", ")}

ğŸ”— Compile Picker: ${CP_LINK}`;
  revealResult(); updateShareButtons();
};

/* ---------- å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ï¼šãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆã‚³ã‚¹ãƒˆç„¡è¦–ï¼‰ ---------- */
function makeSnakeSequence(nEach){
  const pat=[['P1',1],['P2',2],['P1',2],['P2',1]];
  const pat=[["P1",1],["P2",2],["P1",2],["P2",1]];
  const rem={P1:nEach, P2:nEach}, seq=[]; let i=0;
  while(rem.P1>0 || rem.P2>0){
    const [w,t]=pat[i%pat.length], take=Math.min(t, rem[w]);
@@ -325,7 +387,7 @@ <h1>Compile Picker</h1>
document.getElementById('draftRandom').onclick = ()=>{
  const pool = getPool().slice();
  const N = +cntIn.value;
  if(pool.length < 2*N){ out.textContent = `ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ${2*N}ä»¥ä¸Šå¿…è¦ï¼‰ã€‚`; revealResult(); return; }
  if(pool.length < 2*N){ out.textContent = `ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ${2*N}ä»¥ä¸Šå¿…è¦ï¼‰ã€‚`; revealResult(); updateShareButtons(); return; }

  const first = Math.random()<0.5 ? 'P1' : 'P2';
  const bag = shuffle(pool);
@@ -345,8 +407,10 @@ <h1>Compile Picker</h1>
${fmt(picks.P2)}

æ®‹ã‚Šãƒ—ãƒ¼ãƒ« (${bag.length})
- ${bag.join(", ")}`;
  revealResult();
- ${bag.join(", ")}

ğŸ”— Compile Picker: ${CP_LINK}`;
  revealResult(); updateShareButtons();
};

/* ---------- åˆæœŸåŒ– ---------- */
@@ -359,11 +423,6 @@ <h1>Compile Picker</h1>
  localStorage.setItem(LS.pool, dMain.concat(auxSet).join("\n"));
}
loadAll();

/* ä¸‹éƒ¨å›ºå®šãƒãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼ */
document.getElementById('runDraftRatio').onclick  = ()=> document.getElementById('draftRatio').click();
document.getElementById('runDraftRandom').onclick = ()=> document.getElementById('draftRandom').click();
document.getElementById('runBuild').onclick       = ()=> document.getElementById('pickRatioBuild').click();
</script>

<footer>
