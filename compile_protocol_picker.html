<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Compile Picker</title>
<style>
  :root{
    --bg:#0d1117;--panel:#111418;--panel2:#151a21;
    --line:#263244;--fg:#e6edf3;--muted:#9aa6b2;
    --link:#58a6ff;--btn:#1e2630;--btn-hover:#273040;
  }
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,Arial,sans-serif;
    background:var(--bg);color:var(--fg);margin:24px;
  }
  h1{font-size:18px;margin:0 0 14px;letter-spacing:0.2px}
  .panel{max-width:960px;margin:0 auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .section{padding:14px 16px;border-top:1px solid var(--line)}
  .section:first-child{border-top:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label.small{color:var(--muted);font-size:12px;display:flex;align-items:center;gap:6px}
  input[type="number"], select{
    background:transparent;color:var(--fg);border:1px solid var(--line);
    border-radius:8px;padding:8px 10px;font-size:14px
  }
  input[type="number"]{width:92px}
  button{
    background:var(--btn);border:1px solid var(--line);color:var(--fg);
    padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px
  }
  button:hover{background:var(--btn-hover)}
  textarea{
    width:100%;min-height:160px;background:var(--panel2);color:var(--fg);
    border:1px solid var(--line);border-radius:10px;padding:10px;line-height:1.5;
    font-family:monospace;font-size:14px;white-space:pre-wrap
  }
  .result{white-space:pre-wrap;background:var(--panel2);border:1px dashed var(--line);border-radius:10px;padding:12px;min-height:120px}
  .muted{color:var(--muted)}
  a{color:var(--link);text-decoration:none}
  footer{margin-top:30px;text-align:center;color:var(--muted);font-size:12px}
</style>

<div class="panel">
  <div class="section">
    <div class="row" style="justify-content:space-between">
      <h1>Compile Picker</h1>
      <label class="small"><input type="checkbox" id="auxToggle"> Aux1ï¼ˆHATE/LOVE/APATHYï¼‰ã‚’é™¤å¤–</label>
    </div>
  </div>

  <div class="section">
    <div class="row">
      <label class="small">æšæ•°<input type="number" id="cnt" value="3" min="2" max="6" inputmode="numeric"></label>
      <label class="small">P1 Min<input type="number" id="p1Min" value="7"></label>
      <label class="small">P1 Max<input type="number" id="p1Max" value="8"></label>
      <label class="small">P2 Min<input type="number" id="p2Min" value="7"></label>
      <label class="small">P2 Max<input type="number" id="p2Max" value="8"></label>
      <label class="small">ãƒ¬ã‚·ã‚ª3æšã®åˆ¤å®š
        <select id="buildSide">
          <option value="P1">P1ã®è¨­å®š</option>
          <option value="P2">P2ã®è¨­å®š</option>
        </select>
      </label>
    </div>
  </div>

  <div class="section">
    <div class="row">
      <button id="draftRandom">ãƒ©ãƒ³ãƒ€ãƒ P1vsP2</button>
      <button id="draftRatio">ãƒ¬ã‚·ã‚ªP1vsP2</button>
      <button id="pickRatioBuild">ãƒ¬ã‚·ã‚ª3æš</button>
      <button id="pick3">ãƒ©ãƒ³ãƒ€ãƒ 3æš</button>
    </div>
  </div>

  <div class="section">
    <div id="out" class="result" aria-live="polite"></div>
    <div class="row" id="shareRow" style="justify-content:flex-end;display:none;margin-top:8px">
      <button id="shareBtn">å…±æœ‰</button>
      <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <!-- ãƒ¬ã‚·ã‚ªè¡¨ã‚¨ãƒªã‚¢ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼‹ã‚³ãƒ”ãƒ¼ï¼‰ -->
  <div class="section">
    <textarea id="ratioBuckets" readonly></textarea>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="copyRatioBtn">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<footer>
  2025 ã‚Šã‚…ãƒ¼ (<a href="https://x.com/suke69" target="_blank">@suke69</a>)
</footer>

<!-- éš ã—ãƒ¬ã‚·ã‚ªè¨­å®š -->
<textarea id="ratioTA" style="display:none">FIRE=5
DARKNESS=5
PSYCHIC=5
HATE=5
WATER=3
DEATH=3
GRAVITY=3
LOVE=2
PLAGUE=2
LIFE=2
LIGHT=1
SPEED=1
SPIRIT=1
APATHY=0
METAL=0</textarea>

<script>
// ====== å®šæ•° ======
const dMain=["DEATH","FIRE","GRAVITY","LIFE","LIGHT","METAL","PLAGUE","PSYCHIC","SPEED","SPIRIT","DARKNESS","WATER"];
const auxSet=["HATE","LOVE","APATHY"];
const LS={pool:"compile.pool",ratio:"compile.ratio",params:"compile.params",aux:"compile.auxExcluded"};
const CP_LINK="https://princetottino10-bit.github.io/compile-picker/compile_protocol_picker.html";

// ====== è¦ç´  ======
const auxToggle=document.getElementById('auxToggle');
const ratioBucketsEl=document.getElementById('ratioBuckets');
const ratioTA=document.getElementById('ratioTA');
const copyRatioBtn=document.getElementById('copyRatioBtn');
const out=document.getElementById('out');
const shareRow=document.getElementById('shareRow');
const shareBtn=document.getElementById('shareBtn');
const copyBtn=document.getElementById('copyBtn');
const cntIn=document.getElementById('cnt');
const p1MinIn=document.getElementById('p1Min');
const p1MaxIn=document.getElementById('p1Max');
const p2MinIn=document.getElementById('p2Min');
const p2MaxIn=document.getElementById('p2Max');
const buildSideSel=document.getElementById('buildSide');

// ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
function uniq(lines){const s=new Set(),a=[];for(const l of lines){const t=(l||"").trim().toUpperCase();if(t&&!s.has(t)){s.add(t);a.push(t)}}return a}
function getPool(){return uniq(dMain.concat(auxToggle.checked?[]:auxSet))}
function parseRatio(t){const m={};for(const l of (t||"").split(/\r?\n/)){const s=(l||"").trim();if(!s)continue;const i=s.indexOf("=");if(i<0)continue;const k=s.slice(0,i).trim().toUpperCase();const v=Number(s.slice(i+1).trim());if(k&&!isNaN(v)&&v>=0)m[k]=v;}return m;}
function getRatioMap(){return parseRatio(ratioTA.value)}
// Fisherâ€“Yatesï¼ˆéç ´å£Šï¼‰
function shuffle(array){const a=array.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}

// ====== ãƒ¬ã‚·ã‚ªè¡¨ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ ======
function renderRatioBuckets(){
  const pool=getPool(); const R=getRatioMap();
  const buckets=new Map();
  for(const k of pool){const c=R[k]??1;if(!buckets.has(c))buckets.set(c,[]);buckets.get(c).push(k);}  
  const keys=[...buckets.keys()].sort((a,b)=>b-a);
  const lines=["ãƒ¬ã‚·ã‚ªè¡¨(ã‚ªãƒªã‚¸ãƒŠãƒ«)"];
  for(const v of keys){const arr=(buckets.get(v)||[]).sort((a,b)=>a.localeCompare(b));lines.push(`ã€${v}ã€‘`+arr.join(','));}
  ratioBucketsEl.value=lines.join('\n');
}

// ====== å…±æœ‰ãƒ»ã‚³ãƒ”ãƒ¼ ======
function getShareText(){let txt=(out.textContent||"").trim();if(!txt.includes(CP_LINK))txt+=`\n\nğŸ”— Compile Picker: ${CP_LINK}`;return txt}
function updateShareButtons(){shareRow.style.display=(out.textContent&&out.textContent.trim())?"flex":"none"}
shareBtn.onclick=async()=>{const text=getShareText();try{if(navigator.share){await navigator.share({text})}else{await navigator.clipboard.writeText(text);alert("å…±æœ‰APIãŒä½¿ãˆãªã„ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚")}}catch(e){console.warn(e)}}
copyBtn.onclick=async()=>{const text=getShareText();try{await navigator.clipboard.writeText(text);const o=copyBtn.textContent;copyBtn.textContent="ã‚³ãƒ”ãƒ¼å®Œäº†";setTimeout(()=>copyBtn.textContent=o,1200)}catch(e){alert("ã‚³ãƒ”ãƒ¼å¤±æ•—")}}

copyRatioBtn.onclick=async()=>{try{await navigator.clipboard.writeText(ratioBucketsEl.value);const o=copyRatioBtn.textContent;copyRatioBtn.textContent="ã‚³ãƒ”ãƒ¼å®Œäº†";setTimeout(()=>copyRatioBtn.textContent=o,1200)}catch(e){alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ")}}

// ====== ã‚³ãƒ³ãƒœåˆ—æŒ™ï¼ˆå®‰å…¨ã‚¬ãƒ¼ãƒ‰ä»˜ãï¼‰ ======
function enumerateCombos(pool,N,min,max,costFn){
  const items=pool.map(k=>({k,c:costFn(k)})).sort((a,b)=>a.c-b.c);
  const keys=items.map(x=>x.k),costs=items.map(x=>x.c);
  const pre=[0];for(let i=0;i<costs.length;i++) pre[i+1]=pre[i]+costs[i];
  const res=[],pick=new Array(N);
  function rec(s,d,sum){
    const r=N-d; if(r<0) return; if(s+r>keys.length) return; // â˜…å¢ƒç•Œã‚¬ãƒ¼ãƒ‰
    if(r>0){const minTail=pre[s+r]-pre[s]; if(sum+minTail>max) return;}
    if(d===N){ if(sum>=min&&sum<=max) res.push({set:new Set(pick),arr:pick.slice(),s:sum}); return;}
    for(let i=s;i<=keys.length-r;i++){const c=costs[i]; if(sum+c>max) break; pick[d]=keys[i]; rec(i+1,d+1,sum+c);}
  }
  rec(0,0,0); return res;
}
function costOf(k){const m=getRatioMap();return m[k]??1}

// ====== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ======
document.getElementById('pick3').onclick=()=>{const p=getPool();const n=+cntIn.value||3;out.textContent=p.length?(`ğŸ² ${n}æšãƒ©ãƒ³ãƒ€ãƒ \n- `+shuffle(p).slice(0,Math.min(n,p.length)).join("\n- ")):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚";updateShareButtons()}

document.getElementById('pickRatioBuild').onclick=()=>{
  const pool=getPool(),N=+cntIn.value; if(pool.length<N){out.textContent=`ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™(${N}ä»¥ä¸Šå¿…è¦)`;updateShareButtons();return;}
  const R=getRatioMap(); const cost=k=>R[k]??1; const side=buildSideSel.value;
  const minS=side==="P1"?+p1MinIn.value:+p2MinIn.value; const maxS=side==="P1"?+p1MaxIn.value:+p2MaxIn.value;
  const combos=enumerateCombos(pool,N,minS,maxS,cost);
  if(!combos.length){out.textContent=`æ¡ä»¶(${side}è¨­å®š:åˆè¨ˆ${minS}ã€œ${maxS})ã«è©²å½“ãªã—`;updateShareButtons();return;}
  const pick=combos[Math.floor(Math.random()*combos.length)];
  const list=pick.arr.map(k=>`${k}(${cost(k)})`).join("\n- ");
  out.textContent=`ğŸ§® ãƒ¬ã‚·ã‚ªæ§‹ç¯‰(${side}/${minS}-${maxS}/${N}æš)\n- ${list}\nåˆè¨ˆ:${pick.s}\n\nğŸ”— Compile Picker: ${CP_LINK}`;
  updateShareButtons();
}

document.getElementById('draftRatio').onclick=()=>{
  const pool=getPool(),N=+cntIn.value; if(pool.length<2*N){out.textContent=`ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™(${2*N}ä»¥ä¸Šå¿…è¦)`;updateShareButtons();return;}
  const R=getRatioMap(); const cost=k=>R[k]??1;
  const p1Min=+p1MinIn.value,p1Max=+p1MaxIn.value,p2Min=+p2MinIn.value,p2Max=+p2MaxIn.value;
  const p1Comb=enumerateCombos(pool,N,p1Min,p1Max,cost); if(!p1Comb.length){out.textContent=`P1æ¡ä»¶ã«è©²å½“ãªã—`;updateShareButtons();return;}
  const p1O=shuffle(p1Comb); let best=null;
  for(const c1 of p1O){const rem=pool.filter(x=>!c1.set.has(x)); if(rem.length<N) continue; const p2Comb=enumerateCombos(rem,N,p2Min,p2Max,cost); if(p2Comb.length){best=[c1,p2Comb[Math.floor(Math.random()*p2Comb.length)]]; break;}}
  if(!best){out.textContent=`äº’ã„ã«é‡è¤‡ã—ãªã„2ã‚»ãƒƒãƒˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“`;updateShareButtons();return;}
  const first=Math.random()<0.5?"P1":"P2"; const P1=best[0].arr,P2=best[1].arr;
  const fmt=a=>a.map((k,i)=>`${i+1}. ${k}(${cost(k)})`).join("\n");
  out.textContent=`ğŸŒ€ ãƒ¬ã‚·ã‚ªãƒ‰ãƒ©ãƒ•ãƒˆ(${N}æš)\nå…ˆæ”»:${first}\n\nP1 åˆè¨ˆ=${best[0].s}\n${fmt(P1)}\n\nP2 åˆè¨ˆ=${best[1].s}\n${fmt(P2)}\n\nğŸ”— Compile Picker: ${CP_LINK}`;
  updateShareButtons();
}

document.getElementById('draftRandom').onclick=()=>{
  const pool=getPool(),N=+cntIn.value; if(pool.length<2*N){out.textContent=`ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™(${2*N}ä»¥ä¸Šå¿…è¦)`;updateShareButtons();return;}
  const first=Math.random()<0.5?'P1':'P2'; const bag=shuffle(pool);
  const pat=[["P1",1],["P2",2],["P1",2],["P2",1]]; const rem={P1:N,P2:N},seq=[]; let i=0;
  while(rem.P1>0||rem.P2>0){const[w,t]=pat[i%pat.length],take=Math.min(t,rem[w]); if(take>0){seq.push([w,take]); rem[w]-=take;} i++; if(i>200) break;}
  const picks={P1:[],P2:[]}; for(const[w,t]of seq){picks[w].push(...bag.splice(0,t))}
  const fmt=a=>a.map((k,i)=>`${i+1}. ${k}`).join("\n");
  out.textContent=`ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆ(${N}æš)\nå…ˆæ”»:${first}\n\nP1\n${fmt(picks.P1)}\n\nP2\n${fmt(picks.P2)}\n\næ®‹ã‚Š:${bag.length}\n- ${bag.join(', ') }\n\nğŸ”— Compile Picker: ${CP_LINK}`;
  updateShareButtons();
}

// ====== æ°¸ç¶šï¼ˆAuxåˆ‡æ›¿ã®ã¿ä¿æŒï¼‰ ======
(function init(){
  const savedAux=localStorage.getItem(LS.aux);
  if(savedAux!==null) auxToggle.checked=(savedAux==="1");
  renderRatioBuckets();
})();
auxToggle.addEventListener('change',()=>{renderRatioBuckets();localStorage.setItem(LS.aux,auxToggle.checked?'1':'0')});

// ====== ğŸ§ª Smoke Tests ======
(function tests(){
  try{
    console.group('[Tests] Compile Picker minimal');
    // 0) shuffle ãŒå­˜åœ¨ã—å‰¯ä½œç”¨ãŒãªã„
    const sIn=[1,2,3,4,5]; const sOut=shuffle(sIn); 
    console.assert(Array.isArray(sOut) && sOut.length===sIn.length, 'shuffle returns same length array');
    console.assert(JSON.stringify([...sIn].sort())===JSON.stringify([...sOut].sort()), 'shuffle must preserve elements');

    // 1) ãƒ¬ã‚·ã‚ªè¡¨ãŒå‡ºåŠ›ã•ã‚Œã‚‹
    console.assert(ratioBucketsEl.value.startsWith('ãƒ¬ã‚·ã‚ªè¡¨(ã‚ªãƒªã‚¸ãƒŠãƒ«)'), 'ratio header missing');
    // 2) é™é † & ABCï¼ˆå…ˆé ­ãƒã‚±ãƒƒãƒˆãŒæœ€å¤§å€¤ï¼‰
    const lines=ratioBucketsEl.value.trim().split(/\n/).slice(1);
    const top=lines[0];
    console.assert(/^ã€5ã€‘/.test(top) || /^ã€4ã€‘/.test(top) || /^ã€3ã€‘/.test(top), 'top bucket should be highest ratio');
    // 3) å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã«ãƒªãƒ³ã‚¯ãŒå«ã¾ã‚Œã‚‹
    out.textContent='dummy'; updateShareButtons();
    let txt=(out.textContent||"").trim(); if(!txt.includes(CP_LINK)) txt+=`\n\nğŸ”— Compile Picker: ${CP_LINK}`;
    console.assert(txt.includes('Compile Picker'), 'share text lacks link');
    console.groupEnd();
  }catch(e){ console.error('Tests failed', e); }
})();
</script>
