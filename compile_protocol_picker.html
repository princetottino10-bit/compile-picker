<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Compile Picker</title>
<style>
  :root{
    --bg:#0d1117;--panel:#111418;--panel2:#151a21;
    --line:#263244;--fg:#e6edf3;--muted:#9aa6b2;
    --link:#58a6ff;--btn:#1e2630;--btn-hover:#273040;
  }
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,Arial,sans-serif;
    background:var(--bg);color:var(--fg);margin:24px;
  }
  h1{font-size:18px;margin:0 0 14px;letter-spacing:0.2px}
  .panel{max-width:960px;margin:0 auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .section{padding:14px 16px;border-top:1px solid var(--line)}
  .section:first-child{border-top:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label.small{color:var(--muted);font-size:12px;display:flex;align-items:center;gap:6px}
  input[type="number"], select{
    background:transparent;color:var(--fg);border:1px solid var(--line);
    border-radius:8px;padding:8px 10px;font-size:14px
  }
  input[type="number"]{width:92px}
  button{
    background:var(--btn);border:1px solid var(--line);color:var(--fg);
    padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px
  }
  button:hover{background:var(--btn-hover)}
  textarea{
    width:100%;min-height:160px;background:var(--panel2);color:var(--fg);
    border:1px solid var(--line);border-radius:10px;padding:10px;line-height:1.5;
    font-family:monospace;font-size:14px;white-space:pre-wrap
  }
  .result{white-space:pre-wrap;background:var(--panel2);border:1px dashed var(--line);border-radius:10px;padding:12px;min-height:120px}
  .muted{color:var(--muted)}
  a{color:var(--link);text-decoration:none}
  footer{margin-top:30px;text-align:center;color:var(--muted);font-size:12px}
</style>

<div class="panel">
  <div class="section">
    <div class="row" style="justify-content:space-between">
      <h1>Compile Picker</h1>
      <label class="small"><input type="checkbox" id="auxToggle"> Aux1ÔºàHATE/LOVE/APATHYÔºâ„ÇíÈô§Â§ñ</label>
    </div>
  </div>

  <div class="section">
    <div class="row">
      <label class="small">ÊûöÊï∞<input type="number" id="cnt" value="3" min="2" max="6" inputmode="numeric"></label>
      <label class="small">P1 Min<input type="number" id="p1Min" value="7"></label>
      <label class="small">P1 Max<input type="number" id="p1Max" value="8"></label>
      <label class="small">P2 Min<input type="number" id="p2Min" value="7"></label>
      <label class="small">P2 Max<input type="number" id="p2Max" value="8"></label>
      <label class="small">„É¨„Ç∑„Ç™3Êûö„ÅÆÂà§ÂÆö
        <select id="buildSide">
          <option value="P1">P1„ÅÆË®≠ÂÆö</option>
          <option value="P2">P2„ÅÆË®≠ÂÆö</option>
        </select>
      </label>
    </div>
  </div>

  <div class="section">
    <div class="row">
      <button id="draftRandom">„É©„É≥„ÉÄ„É†P1vsP2</button>
      <button id="draftRatio">„É¨„Ç∑„Ç™P1vsP2</button>
      <button id="pickRatioBuild">„É¨„Ç∑„Ç™3Êûö</button>
      <button id="pick3">„É©„É≥„ÉÄ„É†3Êûö</button>
    </div>
  </div>

  <div class="section">
    <div id="out" class="result" aria-live="polite"></div>
    <div class="row" id="shareRow" style="justify-content:flex-end;display:none;margin-top:8px">
      <button id="shareBtn">ÂÖ±Êúâ</button>
      <button id="copyBtn">„Ç≥„Éî„Éº</button>
    </div>
  </div>

  <!-- „É¨„Ç∑„Ç™Ë°®„Ç®„É™„Ç¢Ôºà„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢Ôºã„Ç≥„Éî„ÉºÔºâ -->
  <div class="section">
    <textarea id="ratioBuckets" readonly></textarea>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="copyRatioBtn">„Ç≥„Éî„Éº</button>
    </div>
  </div>
</div>

<footer>
  2025 „Çä„ÇÖ„Éº (<a href="https://x.com/suke69" target="_blank">@suke69</a>)
</footer>

<!-- Èö†„Åó„É¨„Ç∑„Ç™Ë®≠ÂÆö -->
<textarea id="ratioTA" style="display:none">FIRE=5
DARKNESS=5
PSYCHIC=5
HATE=5
WATER=3
DEATH=3
GRAVITY=3
LOVE=2
PLAGUE=2
LIFE=2
LIGHT=1
SPEED=1
SPIRIT=1
APATHY=0
METAL=0</textarea>

<script>
// ====== ÂÆöÊï∞ ======
const dMain=["DEATH","FIRE","GRAVITY","LIFE","LIGHT","METAL","PLAGUE","PSYCHIC","SPEED","SPIRIT","DARKNESS","WATER"];
const auxSet=["HATE","LOVE","APATHY"];
const LS={pool:"compile.pool",ratio:"compile.ratio",params:"compile.params",aux:"compile.auxExcluded"};
const CP_LINK="https://princetottino10-bit.github.io/compile-picker/compile_protocol_picker.html";

// ====== Ë¶ÅÁ¥† ======
const auxToggle=document.getElementById('auxToggle');
const ratioBucketsEl=document.getElementById('ratioBuckets');
const ratioTA=document.getElementById('ratioTA');
const copyRatioBtn=document.getElementById('copyRatioBtn');
const out=document.getElementById('out');
const shareRow=document.getElementById('shareRow');
const shareBtn=document.getElementById('shareBtn');
const copyBtn=document.getElementById('copyBtn');
const cntIn=document.getElementById('cnt');
const p1MinIn=document.getElementById('p1Min');
const p1MaxIn=document.getElementById('p1Max');
const p2MinIn=document.getElementById('p2Min');
const p2MaxIn=document.getElementById('p2Max');
const buildSideSel=document.getElementById('buildSide');

// ====== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ======
function uniq(lines){const s=new Set(),a=[];for(const l of lines){const t=(l||"").trim().toUpperCase();if(t&&!s.has(t)){s.add(t);a.push(t)}}return a}
function getPool(){return uniq(dMain.concat(auxToggle.checked?[]:auxSet))}
function parseRatio(t){const m={};for(const l of (t||"").split(/\r?\n/)){const s=(l||"").trim();if(!s)continue;const i=s.indexOf("=");if(i<0)continue;const k=s.slice(0,i).trim().toUpperCase();const v=Number(s.slice(i+1).trim());if(k&&!isNaN(v)&&v>=0)m[k]=v;}return m;}
function getRatioMap(){return parseRatio(ratioTA.value)}
// Fisher‚ÄìYatesÔºàÈùûÁ†¥Â£äÔºâ
function shuffle(array){const a=array.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}

// ====== „É¨„Ç∑„Ç™Ë°®Ôºà„ÉÜ„Ç≠„Çπ„ÉàÔºâ ======
function renderRatioBuckets(){
  const pool=getPool(); const R=getRatioMap();
  const buckets=new Map();
  for(const k of pool){const c=R[k]??1;if(!buckets.has(c))buckets.set(c,[]);buckets.get(c).push(k);}  
  const keys=[...buckets.keys()].sort((a,b)=>b-a);
  const lines=["„É¨„Ç∑„Ç™Ë°®(„Ç™„É™„Ç∏„Éä„É´)"];
  for(const v of keys){const arr=(buckets.get(v)||[]).sort((a,b)=>a.localeCompare(b));lines.push(`„Äê${v}„Äë`+arr.join(','));}
  ratioBucketsEl.value=lines.join('\n');
}

// ====== ÂÖ±Êúâ„Éª„Ç≥„Éî„Éº ======
function getShareText(){let txt=(out.textContent||"").trim();if(!txt.includes(CP_LINK))txt+=`\n\nüîó Compile Picker: ${CP_LINK}`;return txt}
function updateShareButtons(){shareRow.style.display=(out.textContent&&out.textContent.trim())?"flex":"none"}
shareBtn.onclick=async()=>{const text=getShareText();try{if(navigator.share){await navigator.share({text})}else{await navigator.clipboard.writeText(text);alert("ÂÖ±ÊúâAPI„Åå‰Ωø„Åà„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ")}}catch(e){console.warn(e)}}
copyBtn.onclick=async()=>{const text=getShareText();try{await navigator.clipboard.writeText(text);const o=copyBtn.textContent;copyBtn.textContent="„Ç≥„Éî„ÉºÂÆå‰∫Ü";setTimeout(()=>copyBtn.textContent=o,1200)}catch(e){alert("„Ç≥„Éî„ÉºÂ§±Êïó")}}

copyRatioBtn.onclick=async()=>{try{await navigator.clipboard.writeText(ratioBucketsEl.value);const o=copyRatioBtn.textContent;copyRatioBtn.textContent="„Ç≥„Éî„ÉºÂÆå‰∫Ü";setTimeout(()=>copyRatioBtn.textContent=o,1200)}catch(e){alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü")}}

// ====== „Ç≥„É≥„ÉúÂàóÊåôÔºàÂÆâÂÖ®„Ç¨„Éº„Éâ‰ªò„ÅçÔºâ ======
function enumerateCombos(pool,N,min,max,costFn){
  const items=pool.map(k=>({k,c:costFn(k)})).sort((a,b)=>a.c-b.c);
  const keys=items.map(x=>x.k),costs=items.map(x=>x.c);
  const pre=[0];for(let i=0;i<costs.length;i++) pre[i+1]=pre[i]+costs[i];
  const res=[],pick=new Array(N);
  function rec(s,d,sum){
    const r=N-d; if(r<0) return; if(s+r>keys.length) return; // ‚òÖÂ¢ÉÁïå„Ç¨„Éº„Éâ
    if(r>0){const minTail=pre[s+r]-pre[s]; if(sum+minTail>max) return;}
    if(d===N){ if(sum>=min&&sum<=max) res.push({set:new Set(pick),arr:pick.slice(),s:sum}); return;}
    for(let i=s;i<=keys.length-r;i++){const c=costs[i]; if(sum+c>max) break; pick[d]=keys[i]; rec(i+1,d+1,sum+c);}
  }
  rec(0,0,0); return res;
}
function costOf(k){const m=getRatioMap();return m[k]??1}

// ====== „Ç¢„ÇØ„Ç∑„Éß„É≥ ======
document.getElementById('pick3').onclick=()=>{const p=getPool();const n=+cntIn.value||3;out.textContent=p.length?(`üé≤ ${n}Êûö„É©„É≥„ÉÄ„É†\n- `+shuffle(p).slice(0,Math.min(n,p.length)).join("\n- ")):"„É™„Çπ„Éà„ÅåÁ©∫„Åß„Åô„ÄÇ";updateShareButtons()}

document.getElementById('pickRatioBuild').onclick=()=>{
  const pool=getPool(),N=+cntIn.value; if(pool.length<N){out.textContent=`„Éó„Éº„É´„ÅåÂ∞ë„Å™„Åô„Åé„Åæ„Åô(${N}‰ª•‰∏äÂøÖË¶Å)`;updateShareButtons();return;}
  const R=getRatioMap(); const cost=k=>R[k]??1; const side=buildSideSel.value;
  const minS=side==="P1"?+p1MinIn.value:+p2MinIn.value; const maxS=side==="P1"?+p1MaxIn.value:+p2MaxIn.value;
  const combos=enumerateCombos(pool,N,minS,maxS,cost);
  if(!combos.length){out.textContent=`Êù°‰ª∂(${side}Ë®≠ÂÆö:ÂêàË®à${minS}„Äú${maxS})„Å´Ë©≤ÂΩì„Å™„Åó`;updateShareButtons();return;}
  const pick=combos[Math.floor(Math.random()*combos.length)];
  const list=pick.arr.map(k=>`${k}(${cost(k)})`).join("\n- ");
  out.textContent=`üßÆ „É¨„Ç∑„Ç™ÊßãÁØâ(${side}/${minS}-${maxS}/${N}Êûö)\n- ${list}\nÂêàË®à:${pick.s}\n\nüîó Compile Picker: ${CP_LINK}`;
  updateShareButtons();
}

document.getElementById('draftRatio').onclick=()=>{
  const pool=getPool(),N=+cntIn.value; if(pool.length<2*N){out.textContent=`„Éó„Éº„É´„ÅåÂ∞ë„Å™„Åô„Åé„Åæ„Åô(${2*N}‰ª•‰∏äÂøÖË¶Å)`;updateShareButtons();return;}
  const R=getRatioMap(); const cost=k=>R[k]??1;
  const p1Min=+p1MinIn.value,p1Max=+p1MaxIn.value,p2Min=+p2MinIn.value,p2Max=+p2MaxIn.value;
  const p1Comb=enumerateCombos(pool,N,p1Min,p1Max,cost); if(!p1Comb.length){out.textContent=`P1Êù°‰ª∂„Å´Ë©≤ÂΩì„Å™„Åó`;updateShareButtons();return;}
  const p1O=shuffle(p1Comb); let best=null;
  for(const c1 of p1O){const rem=pool.filter(x=>!c1.set.has(x)); if(rem.length<N) continue; const p2Comb=enumerateCombos(rem,N,p2Min,p2Max,cost); if(p2Comb.length){best=[c1,p2Comb[Math.floor(Math.random()*p2Comb.length)]]; break;}}
  if(!best){out.textContent=`‰∫í„ÅÑ„Å´ÈáçË§á„Åó„Å™„ÅÑ2„Çª„ÉÉ„Éà„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì`;updateShareButtons();return;}
  const first=Math.random()<0.5?"P1":"P2"; const P1=best[0].arr,P2=best[1].arr;
  const fmt=a=>a.map((k,i)=>`${i+1}. ${k}(${cost(k)})`).join("\n");
  out.textContent=`üåÄ „É¨„Ç∑„Ç™„Éâ„É©„Éï„Éà(${N}Êûö)\nÂÖàÊîª:${first}\n\nP1 ÂêàË®à=${best[0].s}\n${fmt(P1)}\n\nP2 ÂêàË®à=${best[1].s}\n${fmt(P2)}\n\nüîó Compile Picker: ${CP_LINK}`;
  updateShareButtons();
}

document.getElementById('draftRandom').onclick=()=>{
  const pool=getPool(),N=+cntIn.value; if(pool.length<2*N){out.textContent=`„Éó„Éº„É´„ÅåÂ∞ë„Å™„Åô„Åé„Åæ„Åô(${2*N}‰ª•‰∏äÂøÖË¶Å)`;updateShareButtons();return;}
  const first=Math.random()<0.5?'P1':'P2'; const bag=shuffle(pool);
  const pat=[["P1",1],["P2",2],["P1",2],["P2",1]]; const rem={P1:N,P2:N},seq=[]; let i=0;
  while(rem.P1>0||rem.P2>0){const[w,t]=pat[i%pat.length],take=Math.min(t,rem[w]); if(take>0){seq.push([w,take]); rem[w]-=take;} i++; if(i>200) break;}
  const picks={P1:[],P2:[]}; for(const[w,t]of seq){picks[w].push(...bag.splice(0,t))}
  const fmt=a=>a.map((k,i)=>`${i+1}. ${k}`).join("\n");
  out.textContent=`üé≤ „É©„É≥„ÉÄ„É†„Éâ„É©„Éï„Éà(${N}Êûö)\nÂÖàÊîª:${first}\n\nP1\n${fmt(picks.P1)}\n\nP2\n${fmt(picks.P2)}\n\nÊÆã„Çä:${bag.length}\n- ${bag.join(', ') }\n\nüîó Compile Picker: ${CP_LINK}`;
  updateShareButtons();
}

// ====== Ê∞∏Á∂öÔºàAuxÂàáÊõø„ÅÆ„Åø‰øùÊåÅÔºâ ======
(function init(){
  const savedAux=localStorage.getItem(LS.aux);
  if(savedAux!==null) auxToggle.checked=(savedAux==="1");
  renderRatioBuckets();
})();
auxToggle.addEventListener('change',()=>{renderRatioBuckets();localStorage.setItem(LS.aux,auxToggle.checked?'1':'0')});

// ====== üß™ Smoke Tests ======
(function tests(){
  try{
    console.group('[Tests] Compile Picker minimal');
    // 0) shuffle „ÅåÂ≠òÂú®„ÅóÂâØ‰ΩúÁî®„Åå„Å™„ÅÑ
    const sIn=[1,2,3,4,5]; const sOut=shuffle(sIn); 
    console.assert(Array.isArray(sOut) && sOut.length===sIn.length, 'shuffle returns same length array');
    console.assert(JSON.stringify([...sIn].sort())===JSON.stringify([...sOut].sort()), 'shuffle must preserve elements');

    // 1) „É¨„Ç∑„Ç™Ë°®„ÅåÂá∫Âäõ„Åï„Çå„Çã
    console.assert(ratioBucketsEl.value.startsWith('„É¨„Ç∑„Ç™Ë°®(„Ç™„É™„Ç∏„Éä„É´)'), 'ratio header missing');
    // 2) ÈôçÈ†Ü & ABCÔºàÂÖàÈ†≠„Éê„Ç±„ÉÉ„Éà„ÅåÊúÄÂ§ßÂÄ§Ôºâ
    const lines=ratioBucketsEl.value.trim().split(/\n/).slice(1);
    const top=lines[0];
    console.assert(/^„Äê5„Äë/.test(top) || /^„Äê4„Äë/.test(top) || /^„Äê3„Äë/.test(top), 'top bucket should be highest ratio');
    // 3) ÂÖ±Êúâ„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê„Å´„É™„É≥„ÇØ„ÅåÂê´„Åæ„Çå„Çã
    out.textContent='dummy'; updateShareButtons();
    let txt=(out.textContent||"").trim(); if(!txt.includes(CP_LINK)) txt+=`\n\nüîó Compile Picker: ${CP_LINK}`;
    console.assert(txt.includes('Compile Picker'), 'share text lacks link');
    console.groupEnd();
  }catch(e){ console.error('Tests failed', e); }
})();
</script>
