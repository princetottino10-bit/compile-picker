<!doctype html>
<meta charset="utf-8">
<title>Compile Protocol Picker (Ratio/Capacity preset)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,Arial,sans-serif;background:#0d1117;color:#e6edf3;margin:24px}
  h1{font-size:20px;margin:0 0 10px}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  .card{background:#111827;border:1px solid #263244;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  textarea{width:100%;min-height:120px;background:#0b1220;color:#e6edf3;border:1px solid #263244;border-radius:10px;padding:8px}
  input[type="number"]{background:#0b1220;color:#e6edf3;border:1px solid #263244;border-radius:8px;padding:6px 8px;width:88px}
  button{background:#1f2937;border:1px solid #2d3a4a;color:#e6edf3;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  button:hover{background:#263244}
  .result{white-space:pre-wrap;background:#0b1220;border:1px dashed #2d3a4a;border-radius:10px;padding:10px;min-height:90px;margin-top:8px}
  .small{color:#9aa6b2;font-size:12px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #2d3a4a;border-radius:999px;margin:4px 6px 0 0}
  .badge{display:inline-block;background:#0b1220;border:1px solid #2d3a4a;border-radius:9999px;padding:4px 10px;margin-left:6px}
  @media(max-width:1100px){.grid{grid-template-columns:1fr}}
</style>

<h1>Compile Protocol Pickerï¼ˆãƒ¬ã‚·ã‚ª/ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ï¼‰<span id="activeMap" class="badge">ä½¿ç”¨ä¸­: RATIO</span></h1>

<div class="grid">
  <!-- ãƒ—ãƒ¼ãƒ« -->
  <div class="card">
    <div class="row">
      <label class="small"><input type="checkbox" id="aux"> Aux 1ï¼ˆHATE / LOVE / APATHYï¼‰ã‚’è¿½åŠ </label>
      <span class="small">è¡Œã”ã¨ã«1ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‚ç·¨é›†å¯ã€‚</span>
    </div>
    <textarea id="pool">DEATH
FIRE
GRAVITY
LIFE
LIGHT
METAL
PLAGUE
PSYCHIC
SPEED
SPIRIT
DARKNESS
WATER</textarea>
    <div class="row">
      <button id="reset">åˆæœŸåŒ–</button>
      <button id="shuffle">è¡¨ç¤ºã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
      <button id="clear">çµæœã‚¯ãƒªã‚¢</button>
    </div>
    <div id="chips"></div>
  </div>

  <!-- æŠ½é¸ -->
  <div class="card">
    <div class="row">
      <button id="pick1">1æšãƒ©ãƒ³ãƒ€ãƒ </button>
      <button id="pick3">3æšï¼ˆé‡è¤‡ãªã—ï¼‰</button>
      <button id="draft">ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆP1â†’P2Ã—2â†’P1Ã—2â†’P2ï¼‰</button>
    </div>
    <div class="row">
      <button id="pickCost">ã‚³ã‚¹ãƒˆåˆè¨ˆã§ãƒ©ãƒ³ãƒ€ãƒ æ§‹ç¯‰</button>
      <label class="small">æšæ•° <input type="number" id="cnt" value="3" min="2" max="6"></label>
      <label class="small">åˆè¨ˆMin <input type="number" id="minSum" value="7"></label>
      <label class="small">åˆè¨ˆMax <input type="number" id="maxSum" value="8"></label>
    </div>
    <div id="out" class="result"></div>
    <p class="small">â€»åˆ¤å®šã¯ã€Œä½¿ç”¨ä¸­ãƒãƒƒãƒ—ï¼ˆRATIO/CAPACITYï¼‰ã€ã®å€¤ã€‚CAPACITYã¯å„å€¤ã‚’8ã§ä¸Šé™ã‚¯ãƒªãƒƒãƒ—ã€‚</p>
  </div>

  <!-- ãƒãƒƒãƒ—ç·¨é›† -->
  <div class="card">
    <h3 style="margin:0 0 6px;">æ•°å€¤ãƒãƒƒãƒ—</h3>
    <div class="row">
      <button id="useRatio">ãƒ¬ã‚·ã‚ªã‚’ä½¿ã†</button>
      <button id="useCapacity">ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’ä½¿ã†</button>
      <button id="swapMaps">ãƒ¬ã‚·ã‚ªâ†”ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ å…¥ã‚Œæ›¿ãˆ</button>
    </div>
    <div class="row">
      <div style="flex:1">
        <div class="small">ãƒ¬ã‚·ã‚ªï¼ˆåˆæœŸå€¤ã¯ã‚ãªãŸã®è¨­å®šï¼‰</div>
        <textarea id="ratioTA">FIRE=5
DARKNESS=5
PSYCHIC=5
HATE=5
WATER=3
DEATH=3
GRAVITY=3
LOVE=2
PLAGUE=2
LIFE=2
LIGHT=1
SPEED=1
SPIRIT=1
APATHY=0
METAL=0</textarea>
        <button id="saveRatio">ãƒ¬ã‚·ã‚ªã‚’ä¿å­˜</button>
      </div>
      <div style="flex:1">
        <div class="small">ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ï¼ˆåˆæœŸå€¤ã¯ä¸Šã¨åŒã˜ï¼å„å€¤ã¯è¨ˆç®—æ™‚ã«æœ€å¤§8ã¸ä¸¸ã‚ï¼‰</div>
        <textarea id="capacityTA">FIRE=5
DARKNESS=5
PSYCHIC=5
HATE=5
WATER=3
DEATH=3
GRAVITY=3
LOVE=2
PLAGUE=2
LIFE=2
LIGHT=1
SPEED=1
SPIRIT=1
APATHY=0
METAL=0</textarea>
        <button id="saveCapacity">ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’ä¿å­˜</button>
      </div>
    </div>
    <div id="mapView" class="small" style="margin-top:8px;"></div>
  </div>
</div>

<script>
const dMain = ["DEATH","FIRE","GRAVITY","LIFE","LIGHT","METAL","PLAGUE","PSYCHIC","SPEED","SPIRIT","DARKNESS","WATER"];
const auxSet = ["HATE","LOVE","APATHY"];
const LS_KEYS = { pool:"compile.pool", ratio:"compile.ratio", capacity:"compile.capacity", active:"compile.activeMap", params:"compile.params" };

const poolTA = document.getElementById('pool');
const chips = document.getElementById('chips');
const includeAux = document.getElementById('aux');
const out = document.getElementById('out');
const ratioTA = document.getElementById('ratioTA');
const capacityTA = document.getElementById('capacityTA');
const activeBadge = document.getElementById('activeMap');
const mapView = document.getElementById('mapView');
const cntIn = document.getElementById('cnt');
const minIn = document.getElementById('minSum');
const maxIn = document.getElementById('maxSum');

function uniq(lines){
  const seen=new Set(), arr=[];
  for(const s of lines){ const t=(s||"").trim().toUpperCase(); if(t && !seen.has(t)){ seen.add(t); arr.push(t); } }
  return arr;
}
function getPool(){ return uniq(poolTA.value.split(/\r?\n/)); }
function setPool(list){ poolTA.value = list.join("\n"); renderChips(); }
function renderChips(){ const pool=getPool(); chips.innerHTML = pool.map(p=>`<span class="pill">${p}</span>`).join(""); }
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function sample(a,n){ return shuffle(a).slice(0, Math.min(n,a.length)); }

function parseMap(text){
  const map = Object.create(null);
  for(const line of (text||"").split(/\r?\n/)){
    const t=(line||"").trim(); if(!t) continue;
    const idx=t.indexOf("="); if(idx<0) continue;
    const k=t.slice(0,idx).trim().toUpperCase();
    const v=Number(t.slice(idx+1).trim());
    // 0ã‚’è¨±å¯ï¼ˆAPATHY/METALå¯¾å¿œï¼‰
    if(k && !isNaN(v) && v>=0) map[k]=v;
  }
  return map;
}
function clip8(v){ return Math.min(8, Math.max(0, v)); }

function getActiveKey(){ return localStorage.getItem(LS_KEYS.active) || "RATIO"; }
function setActiveKey(k){ localStorage.setItem(LS_KEYS.active, k); activeBadge.textContent="ä½¿ç”¨ä¸­: "+k; showActivePreview(); }

function getActiveMap(){
  const key = getActiveKey();
  const ratioMap = parseMap(localStorage.getItem(LS_KEYS.ratio) || ratioTA.value);
  const capacityMap = parseMap(localStorage.getItem(LS_KEYS.capacity) || capacityTA.value);
  if(key==="CAPACITY"){
    // è¨ˆç®—æ™‚ã¯å„å€¤ã‚’æœ€å¤§8ã«ä¸¸ã‚ã¦ä½¿ç”¨
    const capped = Object.create(null);
    for(const [k,v] of Object.entries(capacityMap)){ capped[k]=clip8(v); }
    return capped;
  }
  return ratioMap;
}
function showActivePreview(){
  const pool = getPool(), m = getActiveMap();
  const rows = pool.map(k => `${k}: ${m[k] ?? 1}`);
  mapView.textContent = "ç¾åœ¨ã®é©ç”¨æ•°å€¤ï¼ˆ"+getActiveKey()+"ï¼‰ â†’ " + rows.join(" / ");
}

function saveAll(){
  localStorage.setItem(LS_KEYS.pool, poolTA.value);
  localStorage.setItem(LS_KEYS.ratio, ratioTA.value);
  localStorage.setItem(LS_KEYS.capacity, capacityTA.value);
  localStorage.setItem(LS_KEYS.params, JSON.stringify({cnt:+cntIn.value, min:+minIn.value, max:+maxIn.value}));
}

function loadAll(){
  const pool = localStorage.getItem(LS_KEYS.pool);
  if(pool){ poolTA.value = pool; } else { setPool(dMain); }
  const r = localStorage.getItem(LS_KEYS.ratio); if(r) ratioTA.value = r;
  const c = localStorage.getItem(LS_KEYS.capacity); if(c) capacityTA.value = c;
  const params = localStorage.getItem(LS_KEYS.params);
  if(params){ try{ const p=JSON.parse(params)||{}; cntIn.value=p.cnt??3; minIn.value=p.min??7; maxIn.value=p.max??8; }catch(e){} }
  renderChips(); showActivePreview();
}

document.getElementById('reset').onclick = ()=>{ const list=dMain.slice(); if(includeAux.checked) list.push(...auxSet); setPool(list); out.textContent=""; saveAll(); showActivePreview(); };
document.getElementById('shuffle').onclick = ()=>{ setPool(shuffle(getPool())); saveAll(); };
document.getElementById('clear').onclick = ()=> out.textContent="";

document.getElementById('pick1').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 1æšãƒ©ãƒ³ãƒ€ãƒ \n"+sample(p,1)[0]):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; };
document.getElementById('pick3').onclick = ()=>{ const p=getPool(); out.textContent = p.length?("ğŸ² 3æšï¼ˆé‡è¤‡ãªã—ï¼‰\n- "+sample(p,3).join("\n- ")):"ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚"; };
document.getElementById('draft').onclick = ()=>{
  let p=shuffle(getPool()); if(p.length<6){ out.textContent="ãƒ‰ãƒ©ãƒ•ãƒˆã«ã¯æœ€ä½6ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒå¿…è¦ã§ã™ã€‚"; return; }
  const P1=[],P2=[],take=n=>p.splice(0,n),fmt=a=>a.map((x,i)=>`${i+1}. ${x}`).join("\n");
  P1.push(...take(1)); P2.push(...take(2)); P1.push(...take(2)); P2.push(...take(1));
  out.textContent = `ğŸŒ€ ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ©ãƒ•ãƒˆ\n\nP1\n${fmt(P1)}\n\nP2\n${fmt(P2)}\n\næ®‹ã‚Š (${p.length})\n- ${p.join(", ")}`;
};

document.getElementById('pickCost').onclick = ()=>{
  const pool = getPool(), N=+cntIn.value, minS=+minIn.value, maxS=+maxIn.value;
  if(pool.length<N){ out.textContent="ãƒ—ãƒ¼ãƒ«ãŒå°‘ãªã™ãã¾ã™ï¼ˆ"+N+"ä»¥ä¸Šå¿…è¦ï¼‰ã€‚"; return; }
  const M = getActiveMap(); const cost = k => (M[k] ?? 1);
  // æ±ç”¨Nçµ„åˆã›
  const combos=[];
  function rec(start, acc, sum){
    if(acc.length===N){ if(sum>=minS && sum<=maxS) combos.push({tri:acc.slice(), s:sum}); return; }
    for(let i=start;i<pool.length;i++){
      const k=pool[i]; acc.push(k); rec(i+1, acc, sum+cost(k)); acc.pop();
    }
  }
  rec(0, [], 0);
  if(!combos.length){ out.textContent="æ¡ä»¶ï¼ˆåˆè¨ˆ"+minS+"ã€œ"+maxS+" / "+N+"æšï¼‰ã«åˆã†çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ•°å€¤ã‚„ãƒ—ãƒ¼ãƒ«ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚"; return; }
  const pick = combos[Math.floor(Math.random()*combos.length)];
  out.textContent = `ğŸ§® ã‚³ã‚¹ãƒˆåˆè¨ˆï¼ˆ${minS}ã€œ${maxS} / ${N}æšï¼‰\n- ${pick.tri.join("\n- ")}\nåˆè¨ˆ: ${pick.s}ï¼ˆãƒãƒƒãƒ—: ${getActiveKey()}ï¼‰`;
};

// ãƒãƒƒãƒ—ä¿å­˜/åˆ‡æ›¿/å…¥æ›¿
document.getElementById('saveRatio').onclick = ()=>{ localStorage.setItem(LS_KEYS.ratio, ratioTA.value); saveAll(); showActivePreview(); };
document.getElementById('saveCapacity').onclick = ()=>{ localStorage.setItem(LS_KEYS.capacity, capacityTA.value); saveAll(); showActivePreview(); };
document.getElementById('useRatio').onclick = ()=> setActiveKey("RATIO");
document.getElementById('useCapacity').onclick = ()=> setActiveKey("CAPACITY");
document.getElementById('swapMaps').onclick = ()=>{ const r=ratioTA.value, c=capacityTA.value; ratioTA.value=c; capacityTA.value=r; saveAll(); showActivePreview(); };

includeAux.addEventListener('change', ()=>{
  let l=getPool(); if(includeAux.checked){ for(const x of auxSet) if(!l.includes(x)) l.push(x); setPool(l); }
  else{ setPool(l.filter(x=>!auxSet.includes(x))); }
  saveAll(); showActivePreview();
});
poolTA.addEventListener('input', ()=>{ renderChips(); saveAll(); showActivePreview(); });
[cntIn, minIn, maxIn].forEach(el=>el.addEventListener('input', saveAll));

// åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šãƒ¬ã‚·ã‚ª/ã‚­ãƒ£ãƒ‘/ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœªä¿å­˜ãªã‚‰ã€ã“ã“ã§ãƒ‡ãƒ•ã‚©å€¤ã‚’æ¡ç”¨ï¼ˆRATIOã‚’ä½¿ç”¨ï¼‰
if(!localStorage.getItem(LS_KEYS.ratio)) localStorage.setItem(LS_KEYS.ratio, document.getElementById('ratioTA').value);
if(!localStorage.getItem(LS_KEYS.capacity)) localStorage.setItem(LS_KEYS.capacity, document.getElementById('capacityTA').value);
if(!localStorage.getItem(LS_KEYS.params)) localStorage.setItem(LS_KEYS.params, JSON.stringify({cnt:3,min:7,max:8}));
if(!localStorage.getItem(LS_KEYS.pool)) localStorage.setItem(LS_KEYS.pool, document.getElementById('pool').value);
if(!localStorage.getItem(LS_KEYS.active)) localStorage.setItem(LS_KEYS.active, "RATIO");

setActiveKey(localStorage.getItem(LS_KEYS.active));
loadAll();
</script>
